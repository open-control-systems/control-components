name: "Platform Independent Environment Setup"
description: "Setup all prerequisites"
inputs:
  PROJECT_ID:
    description: "Project unique identifier"
    required: true
    default: "project"
  CONFIGURATION_PATH_CCACHE:
    description: "ccache configuration path"
    required: true
    default: ".env/ccache"
  CONFIGURATION_PATH:
    description: "path for various build configurations"
    required: true
    default: ".env"
  LOG_PATH:
    description: "path for various log files"
    required: true
    default: ".log"
  CACHE_PATH:
    description: "path for various caches"
    required: true
    default: ".cache"
runs:
  using: "composite"
  steps:
    - name: Install Prerequisites
      run: |
        echo "Using Configuration Path: ${{ inputs.CONFIGURATION_PATH }}"
        echo "Using Log Path: ${{ inputs.LOG_PATH }}"
        echo "Using Cache Path: ${{ inputs.CACHE_PATH }}"

        mkdir -p "${{ inputs.CONFIGURATION_PATH }}"
        mkdir -p "${{ inputs.LOG_PATH }}"
        mkdir -p "${{ inputs.CACHE_PATH }}"

        set -xe
        sudo apt-get update
        sudo apt-get install -y \
            git wget flex bison gperf python3 python3-pip python3-venv \
            cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0
      shell: bash

    - name: Setup ccache Configuration
      run: |
        ccache_path="${{ inputs.CACHE_PATH }}/ccache"
        ccache_log_file="${{ inputs.LOG_PATH }}/ccache"

        mkdir -p $ccache_path

        echo "export CCACHE_MAXSIZE=512M" >> "${{ inputs.CONFIGURATION_PATH_CCACHE }}"
        echo "export CCACHE_COMPRESS=true" >> "${{ inputs.CONFIGURATION_PATH_CCACHE }}"

        # https://stackoverflow.com/questions/53659419/no-hits-in-gitlab-ci-for-ccache
        echo "export CCACHE_COMPILERCHECK=content" >> "${{ inputs.CONFIGURATION_PATH_CCACHE }}"

        echo "export CCACHE_BASEDIR=$GITHUB_WORKSPACE" >> "${{ inputs.CONFIGURATION_PATH_CCACHE }}"
        echo "export CCACHE_DIR=$GITHUB_WORKSPACE/$ccache_path" >> "${{ inputs.CONFIGURATION_PATH_CCACHE }}"

        echo "export CCACHE_LOGFILE=$GITHUB_WORKSPACE/$ccache_log_file" >> "${{ inputs.CONFIGURATION_PATH_CCACHE }}"
      shell: bash

    - name: Setup ccache Cache
      uses: actions/cache@v4
      with:
        path: ${{ inputs.CACHE_PATH }}/ccache
        key: ccache-${{ runner.os }}-${{ hashFiles('**/*.cpp', '**/*.h') }}
        restore-keys: |
          ccache-${{ runner.os }}-${{ inputs.PROJECT_ID }}
